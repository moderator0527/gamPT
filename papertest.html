<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>원가관리회계 시험지 생성기</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

  <style>
    :root{
      --brand:#10a37f; --bg:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font-family:"Pretendard",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo",Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
    .container{max-width:1200px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;letter-spacing:.2px;
      padding:8px 12px;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);background:#fff}
    .orb{width:12px;height:12px;border-radius:999px;background:radial-gradient(circle at 30% 30%,#8ff3da,var(--brand));
      box-shadow:0 0 14px rgba(16,163,127,.65)}
    .spacer{flex:1}
    .select{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:12px;
      padding:8px 10px;box-shadow:var(--shadow)}
    .select label{font-size:12px;color:var(--muted)}
    .btn{appearance:none;border:none;outline:none;background:var(--brand);color:#fff;
      font-weight:700;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px}
    main{max-width:1200px;margin:18px auto;padding:0 16px 60px}
    .bar{display:flex;align-items:center;justify-content:space-between;margin:12px 0}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);
      border-radius:999px;background:#fff;font-size:12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
    .card .card-body{padding:12px 14px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{text-align:left;padding:12px;background:#f9fafb;border-bottom:1px solid var(--line);font-weight:700}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top}

    /* 인쇄 레이아웃 */
    #print-root{display:none}
    @media print{
      header, main{display:none !important}
      #print-root{display:block}
      @page{size:A4;margin:12mm}
      .sheet{page-break-after:always}
    }
    #print-root .sheet{width:210mm;min-height:297mm;margin:0 auto}
    #print-root h2{font-size:18px;margin:0 0 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:8mm}
    .cell{border:1px solid #d1d5db;border-radius:10px;padding:6mm;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .qtitle{font-weight:700;margin-bottom:6px;font-size:13px}
    .imgwrap{width:100%;height:100%;display:flex;align-items:center;justify-content:center}
    .imgwrap img{max-width:100%;max-height:100%}
    .noimg{font-size:12px;color:#6b7280}
    .ans-table{width:100%;border-collapse:collapse;font-size:13px;margin-top:6mm}
    .ans-table th,.ans-table td{border:1px solid #d1d5db;padding:6px 8px}
    .ans-table th{background:#f3f4f6}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="title"><span class="orb"></span>원가관리회계 시험지 생성기</div>
        <div class="spacer"></div>

        <button class="btn" id="btnAll">전체 보기</button>

        <div class="select">
          <label>단원별</label>
          <select id="selUnit"><option value="">단원 선택</option></select>
        </div>
        <div class="select">
          <label>연도별</label>
          <select id="selYear"><option value="">연도 선택</option></select>
        </div>

        <div class="select">
          <label>정답표 포함</label>
          <input type="checkbox" id="cbAnswer" checked />
        </div>
        <button class="btn" id="btnMake" disabled>시험지 생성 (선택 0)</button>
      </div>
      <div class="row" style="margin-top:6px">
        <span class="hint" id="status">내장 데이터 로딩 대기…</span>
      </div>
    </div>
  </header>

  <main>
    <div class="bar">
      <div class="badge">총 <b id="count">0</b>문항</div>
      <div class="hint">열 구성: 선택 / 연도 / 문제번호 / 단원 / 문제 / 답</div>
    </div>

    <div class="card">
      <div class="card-body">
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:44px">선택</th>
                <th style="width:100px">연도</th>
                <th style="width:120px">문제번호</th>
                <th style="width:140px">단원</th>
                <th>문제</th>
                <th style="width:80px">답</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint" style="margin-top:8px">
        </div>
      </div>
    </div>
  </main>

  <!-- 내장 CSV 데이터 -->
  <script id="data-csv" type="text/plain">
연도,문제번호,단원,문제,답
2025,1,2,25_41,3
2025,2,4,25_42,3
2025,3,14,25_43,4
2025,4,5,25_44,4
2025,5,8,25_45,4
2025,6,12,25_46,3
2025,7,9,25_47,1
2025,8,13,25_48,2
2025,9,15,25_49,3
2025,10,16,25_50,5
2024,1,1,24_41,5
2024,2,2,24_42,3
2024,3,3,24_43,2
2024,4,2,24_44,1
2024,5,13,24_45,2
2024,6,5,24_46,1
2024,7,7,24_47,4
2024,8,8,24_48,5
2024,9,9,24_49,4
2024,10,15,24_50,3
  </script>

  <div id="print-root"></div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const tbody = $('#tbl tbody');
    const countEl = $('#count');
    const selUnit = $('#selUnit');
    const selYear = $('#selYear');
    const statusEl = $('#status');
    const btnMake = $('#btnMake');
    const cbAnswer = $('#cbAnswer');
    const printRoot = $('#print-root');

    let RAW = [];
    let MODE = 'all';
    let selectedIds = new Set();

    // helpers
    const escapeHtml = (s)=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    function uniqueSorted(arr){
      return [...new Set(arr.filter(Boolean))].sort((a,b)=>{
        const na=Number(a), nb=Number(b);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return nb-na;
        return String(a).localeCompare(String(b),'ko');
      });
    }
    function normalizeHeader(h){
      const t = String(h).trim().toLowerCase();
      const map = {
        '연도':'year','년도':'year','year':'year',
        '문제번호':'number','번호':'number','no':'number','문항번호':'number','qno':'number','number':'number',
        '단원':'unit','unit':'unit',
        '문제':'question','문항':'question','question':'question',
        '답':'answer','정답':'answer','answer':'answer'
      };
      return map[t] || t;
    }
    function parseCSV(text){
      const rows = [];
      let i=0, cur='', inQ=false, row=[];
      const pushCell=()=>{ row.push(cur); cur=''; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      while(i<text.length){
        const ch = text[i];
        if(inQ){
          if(ch==='\"'){ if(text[i+1]==='\"'){ cur+='\"'; i++; } else inQ=false; }
          else cur+=ch;
        } else {
          if(ch==='\"') inQ=true;
          else if(ch===',') pushCell();
          else if(ch==='\n'){ pushCell(); pushRow(); }
          else if(ch==='\r'){}
          else cur+=ch;
        }
        i++;
      }
      if(cur!=='' || row.length){ pushCell(); pushRow(); }
      if(rows.length===0) return [];
      const header = rows[0].map(normalizeHeader);
      const idx = {
        year: header.indexOf('year'),
        number: header.indexOf('number'),
        unit: header.indexOf('unit'),
        question: header.indexOf('question'),
        answer: header.indexOf('answer')
      };
      const out=[];
      for(let r=1;r<rows.length;r++){
        const rec = rows[r];
        if(rec.every(v=>String(v||'').trim()==='')) continue;
        out.push({
          year: idx.year>=0 ? (rec[idx.year]||'').trim() : '',
          number: idx.number>=0 ? (rec[idx.number]||'').trim() : '',
          unit: idx.unit>=0 ? (rec[idx.unit]||'').trim() : '',
          question: idx.question>=0 ? (rec[idx.question]||'').trim() : '',
          answer: idx.answer>=0 ? (rec[idx.answer]||'').trim() : ''
        });
      }
      return out;
    }
    function rebuildFilters(data){
      const units = uniqueSorted(data.map(d=>d.unit));
      selUnit.innerHTML = '<option value=\"\">단원 선택</option>' + units.map(u=>`<option value=\"${escapeHtml(u)}\">${escapeHtml(u)}</option>`).join('');
      const years = uniqueSorted(data.map(d=>d.year));
      selYear.innerHTML = '<option value=\"\">연도 선택</option>' + years.map(y=>`<option value=\"${escapeHtml(y)}\">${escapeHtml(y)}</option>`).join('');
    }
    function applyFilter(mode,value,data){
      if(mode==='unit' && value) return data.filter(d=>String(d.unit)===String(value));
      if(mode==='year' && value) return data.filter(d=>String(d.year)===String(value));
      return data;
    }
    const makeId = (rec)=>`${rec.year}::${rec.number}::${rec.unit}::${rec.question}`;

    function render(items){
      tbody.innerHTML = items.map(it=>{
        const id = makeId(it);
        const checked = selectedIds.has(id) ? 'checked' : '';
        return `
        <tr>
          <td><input type="checkbox" class="rowchk" data-id="${escapeHtml(id)}" ${checked}></td>
          <td>${escapeHtml(it.year??'')}</td>
          <td>${escapeHtml(it.number??'')}</td>
          <td>${escapeHtml(it.unit??'')}</td>
          <td>${escapeHtml(it.question??'')}</td>
          <td>${escapeHtml(it.answer??'')}</td>
        </tr>`;
      }).join('');
      tbody.querySelectorAll('.rowchk').forEach((el)=>{
        el.addEventListener('change', (e)=>{
          const rid = e.currentTarget.dataset.id;
          if(e.currentTarget.checked) selectedIds.add(rid);
          else selectedIds.delete(rid);
          updateMakeBtn();
        });
      });
      countEl.textContent = String(items.length);
      updateMakeBtn();
    }
    function updateMakeBtn(){
      const n = selectedIds.size;
      btnMake.textContent = `시험지 생성 (선택 ${n})`;
      btnMake.disabled = n===0;
    }
    function setMode(m){ MODE=m; updateView(); }
    function updateView(){
      let items = RAW;
      if(MODE==='unit' && selUnit.value) items = applyFilter('unit', selUnit.value, RAW);
      else if(MODE==='year' && selYear.value) items = applyFilter('year', selYear.value, RAW);
      render(items);
    }

    // 초기 데이터
    (function boot(){
      const csvNode = document.getElementById('data-csv');
      const text = (csvNode && csvNode.textContent || '').trim();
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(lines.length>=2){
        RAW = parseCSV(text);
        rebuildFilters(RAW);
        setMode('all');
        render(RAW);
        statusEl.textContent = `20251021 데이터 버전. 총 ${RAW.length}문항.`;
      } else {
        statusEl.textContent = '내장 데이터가 없습니다.';
      }
    })();

    // ==== 로컬 파일(같은 경로/ images/) 자동 매칭 ====
    const CANDIDATE_DIRS = ['./', './problems/'];
    const CANDIDATE_EXTS = ['png','jpg','jpeg','webp','PNG','JPG','JPEG','WEBP'];

    function resolveImageURL(baseName){
      // baseName은 확장자 없는 파일명 (예: "24_41")
      return new Promise((resolve)=>{
        let idx = 0;
        const tries = [];
        for(const dir of CANDIDATE_DIRS){
          for(const ext of CANDIDATE_EXTS){
            tries.push(dir + baseName + '.' + ext);
          }
        }
        const tryNext = ()=>{
          if(idx>=tries.length){
            resolve(null); return;
          }
          const url = tries[idx++];
          const img = new Image();
          img.onload = ()=>resolve(url);
          img.onerror = tryNext;
          // img.src = url + '?_=' + Date.now();
          img.src = url;
        };
        tryNext();
      });
    }

    function getSelectedRecords(){
      const idset = new Set(selectedIds);
      return RAW.filter(rec=>idset.has(makeId(rec)));
    }

    function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }

    async function buildSheetAndWaitImages(){
      const records = getSelectedRecords();
      printRoot.innerHTML = '';



      // 페이지들
      const promises = []; // 이미지 로드 대기
      const pages = chunk(records, 4);
      for(const page of pages){
        const sheet = document.createElement('div');
        sheet.className = 'sheet';

        const cellHTML = await Promise.all(page.map(async (rec, idx)=>{
          const key = String(rec.question||'').trim();
          // URL 탐색
          const url = await resolveImageURL(key);
          const cellId = 'imgcell_' + Math.random().toString(36).slice(2);
          let p;
          if(url){
            p = new Promise((res)=>{
              const im = new Image();
              im.onload = res;
              im.onerror = res; // 실패해도 대기는 해제
              im.src = url;
            });
          } else {
            p = Promise.resolve();
          }
          promises.push(p);

          return `
            <div class="cell">
              <div class="qtitle">${escapeHtml(rec.year)}년 · 문항 ${escapeHtml(rec.number)} · 단원 ${escapeHtml(rec.unit)} · ${escapeHtml(rec.question)}</div>
              <div class="imgwrap" id="${cellId}">
                ${url ? `<img src="${url}" alt="${escapeHtml(rec.question)}">` : `<div class="noimg">이미지 없음 (${escapeHtml(rec.question)})</div>`}
              </div>
            </div>`;
        }));

        sheet.innerHTML = `<h2>시험지</h2><div class="grid">${cellHTML.join('')}</div>`;
        printRoot.appendChild(sheet);
      }

      // 정답표
      if(cbAnswer.checked){
        const ans = document.createElement('div');
        ans.className = 'sheet';
        ans.innerHTML = `
          <h2>정답표</h2>
          <table class="ans-table">
            <thead>
              <tr>
                <th style="width:90px">연도</th>
                <th style="width:110px">문제번호</th>
                <th style="width:140px">단원</th>
                <th>문제(파일명)</th>
                <th style="width:90px">정답</th>
              </tr>
            </thead>
            <tbody>
              ${records.map(r=>`<tr>
                <td>${escapeHtml(r.year)}</td>
                <td>${escapeHtml(r.number)}</td>
                <td>${escapeHtml(r.unit)}</td>
                <td>${escapeHtml(r.question)}</td>
                <td style="text-align:center">${escapeHtml(r.answer||'')}</td>
              </tr>`).join('')}
            </tbody>
          </table>`;
        printRoot.appendChild(ans);
      }

      // 모든 이미지가 로딩될 때까지 대기 → 그 다음에 인쇄
      await Promise.all(promises);
    }

    // 이벤트
    $('#btnAll').addEventListener('click', ()=>{
      selUnit.value = ''; selYear.value = ''; setMode('all'); render(RAW);
    });
    selUnit.addEventListener('change',()=>{ setMode('unit'); });
    selYear.addEventListener('change',()=>{ setMode('year'); });

    btnMake.addEventListener('click', async ()=>{
      try{
        btnMake.disabled = true;
        btnMake.textContent = '생성 중...';
        await buildSheetAndWaitImages();
        btnMake.textContent = '인쇄 창 여는 중...';
        window.print();
      }catch(err){
        console.error(err);
        alert('시험지 생성 중 오류가 발생했습니다. 이미지 경로/파일명을 확인해주세요.');
      }finally{
        btnMake.disabled = selectedIds.size===0;
        btnMake.textContent = `시험지 생성 (선택 ${selectedIds.size})`;
      }
    });
  </script>
</body>
</html>
