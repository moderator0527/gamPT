<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì›ê°€ê´€ë¦¬íšŒê³„ ì‹œí—˜ì§€ ìƒì„±ê¸°</title>

  <!-- Screen UI font -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

  <style>
    :root{
      --brand:#10a37f; --bg:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font-family:"Pretendard",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo",Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
    .container{max-width:1200px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;letter-spacing:.2px;
      padding:8px 12px;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);background:#fff}
    .orb{width:12px;height:12px;border-radius:999px;background:radial-gradient(circle at 30% 30%,#8ff3da,var(--brand));
      box-shadow:0 0 14px rgba(16,163,127,.65)}
    .spacer{flex:1}
    .select{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:12px;
      padding:8px 10px;box-shadow:var(--shadow)}
    .select label{font-size:12px;color:var(--muted)}
    .select select{border:none;outline:none;font-size:14px}
    .btn{appearance:none;border:none;outline:none;background:var(--brand);color:#fff;
      font-weight:700;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px}
    main{max-width:1200px;margin:18px auto;padding:0 16px 60px}
    .bar{display:flex;align-items:center;justify-content:space-between;margin:12px 0;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);
      border-radius:999px;background:#fff;font-size:12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
    .card .card-body{padding:12px 14px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{text-align:left;padding:12px;background:#f9fafb;border-bottom:1px solid var(--line);font-weight:700}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top}

    /* ===== Print Layout ===== */
    #print-root{display:none}
    @media print{
      #quickOverlay{display:none !important}

      header, main{display:none !important}
      #print-root{display:block}
      @page{size:A4;margin:10mm}
      .sheet{page-break-after:always}
    }

    /* Print-only font */
    @font-face {
      font-family: 'GungsuhLocalFallback';
      src: local('ê¶ì„œ'), local('Gungsuh');
      font-weight: 400;
      font-style: normal;
    }
    #print-root{
      font-family:'GungsuhLocalFallback','ê¶ì„œ','Gungsuh',serif;
      color:#000;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

    #print-root .sheet{
      position:relative;
      width:210mm;min-height:297mm;margin:0 auto;display:flex;flex-direction:column;
      padding:8mm 8mm 10mm;
    }

    .exam-header{position:relative;padding-top:2mm;padding-bottom:8mm;}
    .exam-title{ text-align:center;font-size:28pt;line-height:1;font-weight:500;letter-spacing:0.5px }
    .exam-session{ position:absolute;top:7mm;right:0;border:0.5px solid #000;padding:0.5mm 5mm;font-size:14pt;line-height:1;font-weight:1000; }

    /* Horizontal rule under title */
    .tmark-h{ position:relative;height:0;margin-top:3mm;border-top:1px solid #000 }

    /* Content wrapper directly under header (where the vertical line & grid live) */
    .content{ position:relative; width:100%; flex:1; }

    /* Vertical line: starts below header area only */
    .page-vline{
      position:absolute;
      left:50%; transform:translateX(-50%);
      top:-32px; bottom:0;         /* -32px below the content's top (i.e., under the header) */
      border-left:1px solid #000;
      pointer-events:none;
      z-index:1;                  /* keep low; images won't be occluded */
    }

    /* 2Ã—2 fixed grid of images */
    .grid-2x2{
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-template-rows:1fr 1fr;
      column-gap:5mm;            /* wider center gutter so vertical line has space */
      row-gap:15mm;
      width:100%;
      flex:1;
      margin-top:-2mm;
    }
    .qimg{
      display:flex;align-items:center;justify-content:center;
      padding:0;
    }
    /* Pull images a bit away from the center line */
    .grid-2x2 > .qimg:nth-child(odd){  /* left column cells: 1,3 */
      padding-right:3mm;
    }
    .grid-2x2 > .qimg:nth-child(even){ /* right column cells: 2,4 */
      padding-left:3mm;
    }
    .qimg img{max-width:100%;max-height:100%;display:block}
    .sheet-footer{height:0}

    /* ===== Answer sheet styles ===== */
    .answer-title{ text-align:center;font-size:20pt;font-weight:700;margin-top:2mm;margin-bottom:6mm }
    .answer-table{ width:100%; border-collapse:collapse; font-size:12pt }
    .answer-table th, .answer-table td{ border:1px solid #000; padding:3mm 2mm; text-align:center }
    .answer-meta{ display:flex; justify-content:flex-end; gap:12mm; margin-bottom:4mm }


    /* ===== Quick Grader (Modal) ===== */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      background:#fff; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.25);
      width:min(1100px, 96vw); max-height:90vh; overflow:auto; padding:18px 18px 22px; position:relative;
      font-family:"Pretendard",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;
    }
    .modal .close-x{
      position:absolute; right:10px; top:8px; font-size:20px; font-weight:800; color:#6b7280; cursor:pointer; user-select:none;
    }
    .modal h3{ margin:0 0 10px 0; font-weight:800; font-size:18px; }
    .quick-table{ width:100%; border-collapse:collapse; table-layout:fixed; margin-top:6px; }
    .quick-table th,.quick-table td{ border:1px solid #e5e7eb; padding:10px 6px; text-align:center; font-size:14px; }
    .quick-table thead th{ background:#f9fafb; font-weight:700; }
    .quick-sec{ margin-bottom:12px; }
    .ans-input{ width:100%; max-width:48px; text-align:center; border:1px solid #d1d5db; border-radius:8px; padding:6px 4px; }
    .mark-o{ color:#2563eb; font-weight:800; }   /* blue O */
    .mark-x{ color:#ef4444; font-weight:800; }   /* red X  */
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .modal .btn-secondary{ background:#111827; color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }

  
    /* ===== Quick Grader (Modal) ===== */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      background:#fff; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.25);
      width:min(1100px, 96vw); max-height:90vh; overflow:auto; padding:18px 18px 22px; position:relative;
    }
    .modal .close-x{
      position:absolute; right:10px; top:8px; font-size:20px; font-weight:800; color:#6b7280; cursor:pointer; user-select:none;
    }
    .modal h3{ margin:0 0 10px 0; font-weight:800; font-size:18px; }
    .quick-table{ width:100%; border-collapse:collapse; margin-top:6px; }
    .quick-table th,.quick-table td{ border:1px solid #e5e7eb; padding:10px 6px; text-align:center; font-size:14px; }
    .quick-table thead th{ background:#f9fafb; font-weight:700; }
    .quick-sec{ margin-bottom:12px; }
    .ans-input{ width:100%; max-width:48px; text-align:center; border:1px solid #d1d5db; border-radius:8px; padding:6px 4px; }
    .mark-o{ color:#2563eb; font-weight:800; }
    .mark-x{ color:#ef4444; font-weight:800; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .modal .btn-secondary{ background:#111827; color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }

</style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="title"><span class="orb"></span>ì›ê°€ê´€ë¦¬íšŒê³„ ì‹œí—˜ì§€ ìƒì„±ê¸°</div>
        <div class="spacer"></div>

        <button class="btn" id="btnAll">ì „ì²´ ë³´ê¸°</button>
        <div class="select">
          <label>ë‹¨ì›ë³„</label>
          <select id="selUnit"><option value="">ë‹¨ì› ì„ íƒ</option></select>
        </div>
        <div class="select">
          <label>ì—°ë„ë³„</label>
          <select id="selYear"><option value="">ì—°ë„ ì„ íƒ</option></select>
        </div>
        <div class="select"><label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="chkAnswers"> ì •ë‹µí‘œ í¬í•¨</label></div>
        <button class="btn" id="btnQuick">ë¹ ë¥¸ ì±„ì </button>
        <button class="btn" id="btnMake" disabled>ì‹œí—˜ì§€ ìƒì„± (ì„ íƒ 0)</button>
      </div>

      <div class="row" style="margin-top:6px;gap:8px">
        <span class="hint" id="status">ë°ì´í„° ë¡œë”© ì¤€ë¹„â€¦</span>
      </div>
    </div>
  </header>

  <main>
    <div class="bar">
      <div class="badge">ì´ <b id="count">0</b>ë¬¸í•­</div>
      <div class="hint">ì—´ êµ¬ì„±: ì—°ë„ / ë¬¸ì œë²ˆí˜¸ / ë‹¨ì› / ë¬¸ì œ(íŒŒì¼ëª…) / ì •ë‹µ</div>
    </div>

    <div class="card">
      <div class="card-body">
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:44px">ì„ íƒ</th>
                <th style="width:100px">ì—°ë„</th>
                <th style="width:120px">ë¬¸ì œë²ˆí˜¸</th>
                <th style="width:140px">ë‹¨ì›</th>
                <th>ë¬¸ì œ</th>
                <th style="width:80px">ì •ë‹µ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Fallback embedded CSV -->
  <script id="data-csv" type="text/plain">
ì—°ë„,ë¬¸ì œë²ˆí˜¸,ë‹¨ì›,ë¬¸ì œ,ë‹µ
2025,1,2,25_41,3
2025,2,4,25_42,3
2025,3,14,25_43,4
2025,4,5,25_44,4
2025,5,8,25_45,4
2025,6,12,25_46,3
2025,7,9,25_47,1
2025,8,13,25_48,2
2025,9,15,25_49,3
2025,10,16,25_50,5
2024,1,1,24_41,5
2024,2,2,24_42,3
2024,3,3,24_43,2
2024,4,2,24_44,1
2024,5,13,24_45,2
2024,6,5,24_46,1
2024,7,7,24_47,4
2024,8,8,24_48,5
2024,9,9,24_49,4
2024,10,15,24_50,3
  </script>

  <!-- Optional legacy hooks -->
  <script id="legacy-json" type="application/json" data-format="json"></script>
  <table id="rawData" style="display:none"></table>

  <div id="print-root"></div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const tbody = $('#tbl tbody');
    const countEl = $('#count');
    const selUnit = $('#selUnit');
    const selYear = $('#selYear');
    const statusEl = $('#status');
    const btnMake = $('#btnMake');
    const printRoot = $('#print-root');

    let RAW = [];
    let MODE = 'all';
    let selectedIds = new Set();
    let dataSourceNote = '';

    // helpers
    const escapeHtml = (s)=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    function uniqueSorted(arr){
      return [...new Set(arr.filter(Boolean))].sort((a,b)=>{
        const na=Number(a), nb=Number(b);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return nb-na;
        return String(a).localeCompare(String(b),'ko');
      });
    }
    function normalizeHeader(h){
      const t = String(h).trim().toLowerCase();
      const map = {
        'ì—°ë„':'year','ë…„ë„':'year','year':'year',
        'ë¬¸ì œë²ˆí˜¸':'number','ë²ˆí˜¸':'number','no':'number','ë¬¸í•­ë²ˆí˜¸':'number','qno':'number','number':'number',
        'ë‹¨ì›':'unit','unit':'unit',
        'ë¬¸ì œ':'question','ë¬¸í•­':'question','question':'question','íŒŒì¼':'question','íŒŒì¼ëª…':'question','ì´ë¦„':'question',
        'ë‹µ':'answer','ì •ë‹µ':'answer','answer':'answer'
      };
      return map[t] || t;
    }
    function parseCSV(text){
      if(!text) return [];
      const sep = text.indexOf('\t')>=0 && text.indexOf(',')===-1 ? '\t' : ',';
      const rows = [];
      let i=0, cur='', inQ=false, row=[];
      const pushCell=()=>{ row.push(cur); cur=''; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      while(i<text.length){
        const ch = text[i];
        if(inQ){
          if(ch==='\"'){ if(text[i+1]==='\"'){ cur+='\"'; i++; } else inQ=false; }
          else cur+=ch;
        } else {
          if(ch==='\"') inQ=true;
          else if(ch===sep) pushCell();
          else if(ch==='\n'){ pushCell(); pushRow(); }
          else if(ch==='\r'){} else cur+=ch;
        }
        i++;
      }
      if(cur!=='' || row.length){ pushCell(); pushRow(); }
      if(rows.length===0) return [];
      const header = rows[0].map(normalizeHeader);
      const idx = {
        year: header.indexOf('year'),
        number: header.indexOf('number'),
        unit: header.indexOf('unit'),
        question: header.indexOf('question'),
        answer: header.indexOf('answer')
      };
      const out=[];
      for(let r=1;r<rows.length;r++){
        const rec = rows[r];
        if(!rec || rec.every(v=>String(v||'').trim()==='')) continue;
        out.push({
          year: idx.year>=0 ? (rec[idx.year]||'').trim() : '',
          number: idx.number>=0 ? (rec[idx.number]||'').trim() : '',
          unit: idx.unit>=0 ? (rec[idx.unit]||'').trim() : '',
          question: idx.question>=0 ? (rec[idx.question]||'').trim() : '',
          answer: idx.answer>=0 ? (rec[idx.answer]||'').trim() : ''
        });
      }
      return out;
    }
    function parseJSON(text){
      try{
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) return [];
        return arr.map(obj=>({
          year: (obj.year ?? obj.ì—°ë„ ?? obj.ë…„ë„ ?? '').toString(),
          number: (obj.number ?? obj.no ?? obj.ë¬¸ì œë²ˆí˜¸ ?? obj.ë²ˆí˜¸ ?? '').toString(),
          unit: (obj.unit ?? obj.ë‹¨ì› ?? '').toString(),
          question: (obj.question ?? obj.ë¬¸ì œ ?? obj.íŒŒì¼ëª… ?? obj.file ?? '').toString(),
          answer: (obj.answer ?? obj.ì •ë‹µ ?? obj.ë‹µ ?? '').toString()
        }));
      }catch(e){ return []; }
    }
    function parseHTMLTable(table){
      if(!table) return [];
      const ths = Array.from(table.querySelectorAll('thead th, tr:first-child th, tr:first-child td')).map(el=>normalizeHeader(el.textContent));
      const idx = {
        year: ths.indexOf('year'),
        number: ths.indexOf('number'),
        unit: ths.indexOf('unit'),
        question: ths.indexOf('question'),
        answer: ths.indexOf('answer')
      };
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const startRows = rows.length ? rows : Array.from(table.querySelectorAll('tr')).slice(1);
      return startRows.map(tr=>{
        const tds = Array.from(tr.children);
        const pick = (i)=> (i>=0 && tds[i]) ? tds[i].textContent.trim() : '';
        return {
          year: pick(idx.year), number: pick(idx.number), unit: pick(idx.unit),
          question: pick(idx.question), answer: pick(idx.answer)
        };
      }).filter(r=>Object.values(r).some(v=>v));
    }
    function rebuildFilters(data){
      const units = uniqueSorted(data.map(d=>d.unit));
      selUnit.innerHTML = '<option value=\"\">ë‹¨ì› ì„ íƒ</option>' + units.map(u=>`<option value=\"${escapeHtml(u)}\">${escapeHtml(u)}</option>`).join('');
      const years = uniqueSorted(data.map(d=>d.year));
      selYear.innerHTML = '<option value=\"\">ì—°ë„ ì„ íƒ</option>' + years.map(y=>`<option value=\"${escapeHtml(y)}\">${escapeHtml(y)}</option>`).join('');
    }
    function applyFilter(mode,value,data){
      if(mode==='unit' && value) return data.filter(d=>String(d.unit)===String(value));
      if(mode==='year' && value) return data.filter(d=>String(d.year)===String(value));
      return data;
    }
    const makeId = (rec)=>`${rec.year}::${rec.number}::${rec.unit}::${rec.question}`;

    function render(items){
      tbody.innerHTML = items.map(it=>{
        const id = makeId(it);
        const checked = selectedIds.has(id) ? 'checked' : '';
        return `
        <tr>
          <td><input type="checkbox" class="rowchk" data-id="${escapeHtml(id)}" ${checked}></td>
          <td>${escapeHtml(it.year??'')}</td>
          <td>${escapeHtml(it.number??'')}</td>
          <td>${escapeHtml(it.unit??'')}</td>
          <td>${escapeHtml(it.question??'')}</td>
          <td>${escapeHtml(it.answer??'')}</td>
        </tr>`;
      }).join('');
      tbody.querySelectorAll('.rowchk').forEach((el)=>{
        el.addEventListener('change', (e)=>{
          const rid = e.currentTarget.dataset.id;
          if(e.currentTarget.checked) selectedIds.add(rid);
          else selectedIds.delete(rid);
          updateMakeBtn();
        });
      });
      countEl.textContent = String(items.length);
      updateMakeBtn();
    }
    function updateMakeBtn(){
      const n = selectedIds.size;
      btnMake.textContent = `ì‹œí—˜ì§€ ìƒì„± (ì„ íƒ ${n})`;
      btnMake.disabled = n===0;
    }
    function setMode(m){ MODE=m; updateView(); }
    function updateView(){
      let items = RAW;
      if(MODE==='unit' && selUnit.value) items = applyFilter('unit', selUnit.value, RAW);
      else if(MODE==='year' && selYear.value) items = applyFilter('year', selYear.value, RAW);
      render(items);
    }

    function mergeUnique(base, extra){
      const set = new Set(base.map(makeId));
      const out = base.slice();
      for(const r of extra||[]){
        const rec = {
          year: (r.year??'').toString().trim(),
          number: (r.number??'').toString().trim(),
          unit: (r.unit??'').toString().trim(),
          question: (r.question??'').toString().trim(),
          answer: (r.answer??'').toString().trim(),
        };
        const id = makeId(rec);
        if(rec.question && !set.has(id)){ out.push(rec); set.add(id); }
      }
      return out;
    }

    function detectAndLoadAllSources(){
      let data = [];
      dataSourceNote = '';

      // JSON blocks
      const jsonBlocks = Array.from(document.querySelectorAll('script[type="application/json"][data-format="json"], script[type="application/json"][data-role="problems"]'));
      for(const s of jsonBlocks){
        const arr = parseJSON(s.textContent);
        if(arr.length){
          data = mergeUnique(data, arr);
          dataSourceNote += `JSON ${arr.length}ê±´, `;
        }
      }

      // CSV blocks
      const csvBlocks = Array.from(document.querySelectorAll('script[type="text/plain"][data-format="csv"], script#data-csv[type="text/plain"]'));
      for(const s of csvBlocks){
        const arr = parseCSV((s.textContent||'').trim());
        if(arr.length){
          data = mergeUnique(data, arr);
          dataSourceNote += `CSV ${arr.length}ê±´, `;
        }
      }

      // HTML table
      const table = document.querySelector('#rawData,[data-role="raw-data"]');
      if(table){
        const arr = parseHTMLTable(table);
        if(arr.length){
          data = mergeUnique(data, arr);
          dataSourceNote += `TABLE ${arr.length}ê±´, `;
        }
      }

      if(!data.length){
        dataSourceNote = 'ë‚´ì¥ ì˜ˆì‹œ ë°ì´í„° ì‚¬ìš©';
      }else{
        dataSourceNote = dataSourceNote.replace(/, $/, '');
      }

      return data;
    }

    // ==== ì´ë¯¸ì§€ ìë™ ë§¤ì¹­ ====
    const CANDIDATE_DIRS = ['./', './problems/'];
    const CANDIDATE_EXTS = ['png','jpg','jpeg','webp','PNG','JPG','JPEG','WEBP'];
    function resolveImageURL(baseName){
      return new Promise((resolve)=>{
        let idx = 0;
        const tries = [];
        for(const dir of CANDIDATE_DIRS){
          for(const ext of CANDIDATE_EXTS){
            tries.push(dir + baseName + '.' + ext);
          }
        }
        const tryNext = ()=>{
          if(idx>=tries.length){ resolve(null); return; }
          const url = tries[idx++];
          const img = new Image();
          img.onload = ()=>resolve(url);
          img.onerror = tryNext;
          img.src = url;
        };
        tryNext();
      });
    }

    function getSelectedRecords(){
      const idset = new Set(selectedIds);
      return RAW.filter(rec=>idset.has(makeId(rec)));
    }
    function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }

    async function buildSheets(){
      const includeAnswers = (document.getElementById('chkAnswers')?.checked) === true;

      const records = getSelectedRecords();
      printRoot.innerHTML = '';

      const groups = chunk(records, 4);
      const imgPromises = [];

      for(const group of groups){
        const sheet = document.createElement('div');
        sheet.className = 'sheet';

        // header
        const header = document.createElement('div');
        header.className = 'exam-header';
        header.innerHTML = `
          <div class="exam-title">ì›ê°€ê´€ë¦¬íšŒê³„</div>
          <div class="exam-session">1êµì‹œ</div>
          <div class="tmark-h"></div>
        `;
        sheet.appendChild(header);

        // content (holds vertical line + grid)
        const content = document.createElement('div');
        content.className = 'content';

        // vertical line
        const vline = document.createElement('div');
        vline.className = 'page-vline';
        content.appendChild(vline);

        // 2x2 grid
        const grid = document.createElement('div');
        grid.className = 'grid-2x2';

        for(const rec of group){
          const cell = document.createElement('div');
          cell.className = 'qimg';
          const key = String(rec.question||'').trim();
          const p = resolveImageURL(key).then(url=>{
            if(url){
              const im = new Image();
              im.src = url;
              cell.appendChild(im);
              return new Promise(r=>{ im.onload = r; im.onerror = r; });
            }else{
              const miss = document.createElement('div');
              miss.className = 'hint';
              miss.textContent = `ì´ë¯¸ì§€ ì—†ìŒ: ${key}`;
              cell.appendChild(miss);
            }
          });
          imgPromises.push(p);
          grid.appendChild(cell);
        }
        // pad to 4
        for(let i=group.length;i<4;i++){
          const pad = document.createElement('div');
          pad.className = 'qimg';
          grid.appendChild(pad);
        }

        content.appendChild(grid);
        sheet.appendChild(content);
        sheet.appendChild(Object.assign(document.createElement('div'), {className:'sheet-footer'}));
        printRoot.appendChild(sheet);
      }

      await Promise.all(imgPromises);

      if(includeAnswers){
        const ans = document.createElement('div');
        ans.className = 'sheet';

        const header = document.createElement('div');
        header.className = 'exam-header';
        header.innerHTML = `<div class="answer-title">ì •ë‹µí‘œ</div>`;
        ans.appendChild(header);

        const table = document.createElement('table');
        table.className = 'answer-table';
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width:18mm">No.</th>
              <th style="width:24mm">ì—°ë„</th>
              <th style="width:26mm">ë¬¸ì œë²ˆí˜¸</th>
              <th>ë¬¸ì œ(íŒŒì¼ëª…)</th>
              <th style="width:22mm">ì •ë‹µ</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        const records = getSelectedRecords();
        records.forEach((rec, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${rec.year??''}</td>
            <td>${rec.number??''}</td>
            <td>${rec.question??''}</td>
            <td>${rec.answer??''}</td>
          `;
          tbody.appendChild(tr);
        });
        ans.appendChild(table);
        printRoot.appendChild(ans);
      }
    }

    // Init
    (function boot(){
      let data = detectAndLoadAllSources();
      if(!data.length){
        const csvNode = document.getElementById('data-csv');
        const text = (csvNode && csvNode.textContent || '').trim();
        data = parseCSV(text);
      }
      RAW = data;
      if(RAW.length){
        rebuildFilters(RAW); setMode('all'); render(RAW);
        statusEl.textContent = `20251021 ë°ì´í„° ë²„ì „. ì´ 20ë¬¸í•­.`;
      } else {
        statusEl.textContent = 'ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.';
      }
    })();

    // Events
    $('#btnAll').addEventListener('click', ()=>{ selUnit.value=''; selYear.value=''; setMode('all'); render(RAW); });
    selUnit.addEventListener('change',()=>{ setMode('unit'); });
    selYear.addEventListener('change',()=>{ setMode('year'); });

    btnMake.addEventListener('click', async ()=>{
      try{
        btnMake.disabled = true;
        btnMake.textContent = 'ìƒì„± ì¤‘...';
        await buildSheets();
        btnMake.textContent = 'ì¸ì‡„ ì°½ ì—¬ëŠ” ì¤‘...';
        window.print();
      }catch(err){
        console.error(err);
        alert('ì‹œí—˜ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ê²½ë¡œ/íŒŒì¼ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }finally{
        btnMake.disabled = selectedIds.size===0;
        btnMake.textContent = `ì‹œí—˜ì§€ ìƒì„± (ì„ íƒ ${selectedIds.size})`;
      }
    });
  
    
    // ===== Quick Grader (robust, always 20) =====
    document.addEventListener('DOMContentLoaded', () => {
      const quickOverlay = document.getElementById('quickOverlay');
      const quickBody = document.getElementById('quickBody');
      const quickClose = document.getElementById('quickClose');
      const btnQuick = document.getElementById('btnQuick');
      const btnGrade = document.getElementById('btnGrade');

      function buildQuickTable(){
        const N = 20;
        const nums = Array.from({length:N}, (_,i)=>i+1);
        const makeSection = (startIdx) => {
          const end = Math.min(startIdx+10, N);
          const slice = nums.slice(startIdx, end);
          let html = '<div class="quick-sec"><table class="quick-table"><thead><tr><th>ë²ˆí˜¸</th>';
          html += slice.map(n=>`<th>${n} ë²ˆ</th>`).join('');
          html += '</tr></thead><tbody>';
          html += '<tr><td>ë‚´ë‹µ</td>';
          html += slice.map((n)=>`<td><input type="text" class="ans-input" inputmode="numeric" data-q="${n}" /></td>`).join('');
          html += '</tr>';
          html += '<tr><td>ì •ì˜¤</td>';
          html += slice.map((n)=>`<td id="mark-${n}"></td>`).join('');
          html += '</tr></tbody></table></div>';
          return html;
        };
        return makeSection(0) + makeSection(10);
      }

      function openQuickModal(){
        quickBody.innerHTML = buildQuickTable();  // Always 20, independent of selection
        quickOverlay.style.display = 'flex';      // Force show
        if(btnGrade) btnGrade.textContent = 'ì±„ì í•˜ê¸°';
      }

            function gradeQuick(){
        const N = 20;

        // 1) ì •ë‹µí‚¤ ì¶”ì¶œ ìœ í‹¸: ì„ íƒ â†’ í™”ë©´í‘œ â†’ RAW ìˆœìœ¼ë¡œ ë³´ì™„
        function getAnswersFor(n){
          const answers = [];

          // a) ì„ íƒëœ ë¬¸ì œë“¤
          let sel = [];
          try { sel = (typeof getSelectedRecords === 'function') ? getSelectedRecords() : []; } catch {}
          for (let i=0; i<Math.min(n, sel.length); i++){
            answers[i] = String(sel[i]?.answer ?? '').trim();
          }

          // b) í˜„ì¬ í™”ë©´ í…Œì´ë¸” í–‰ë“¤(#tbl tbody)ì—ì„œ ì±„ìš°ê¸°
          const rows = Array.from(document.querySelectorAll('#tbl tbody tr'));
          for (let i=0; i<Math.min(n, rows.length); i++){
            if (!answers[i] || answers[i]===''){
              const tds = rows[i].querySelectorAll('td');
              // ì •ë‹µ ì—´ì€ 6ë²ˆì§¸ ì…€(index 5)
              const cell = tds[5];
              const val = (cell?.textContent || '').trim();
              if (val) answers[i] = val;
            }
          }

          // c) RAW ì „ì²´ì—ì„œ ë³´ì™„
          if (Array.isArray(RAW)){
            for (let i=0; i<Math.min(n, RAW.length); i++){
              if (!answers[i] || answers[i]===''){
                const val = String(RAW[i]?.answer ?? '').trim();
                if (val) answers[i] = val;
              }
            }
          }

          // ê¸¸ì´ në¡œ ë³´ì •
          for (let i=0; i<n; i++){
            if (answers[i] == null) answers[i] = '';
          }
          return answers;
        }

        const key = getAnswersFor(N);

        // ì…ë ¥ê°’ ì½ê³  ì±„ì 
        for (let i=1; i<=N; i++){
          const inp  = document.querySelector(`.ans-input[data-q="${i}"]`);
          const cell = document.getElementById(`mark-${i}`);
          if (!cell) continue;

          const val = (inp?.value ?? '').trim();
          const ans = String(key[i-1] ?? '').trim();

          if (!val || !ans){
            cell.textContent = '';  // ì •ë‹µ ë˜ëŠ” ì…ë ¥ ì—†ìœ¼ë©´ ê³µë€
            continue;
          }

          cell.innerHTML = (val === ans)
            ? '<span class="mark-o">O</span>'
            : '<span class="mark-x">X</span>';
        }

        if (btnGrade) btnGrade.textContent = 'ì¬ì±„ì í•˜ê¸°';
      }


      btnQuick?.addEventListener('click', openQuickModal);
      btnGrade?.addEventListener('click', gradeQuick);
      quickClose?.addEventListener('click', ()=>{ quickOverlay.style.display='none'; });
      quickOverlay?.addEventListener('click', (e)=>{ if(e.target === quickOverlay) quickOverlay.style.display='none'; });

// ===== ë¹ ë¥¸ ì‹œí—˜ì§€ ìƒì„±: ì˜¤ë‹µë§Œ ëª¨ì•„ ê¸°ì¡´ ë””ìì¸ìœ¼ë¡œ ì¶œë ¥ =====
(function(){
  const btn = document.getElementById('btnQuickMakeWrong');
  if(!btn) return;

  // í™”ë©´ì˜ 1~20ë²ˆì— ëŒ€í•´, ì„ íƒ â–¶ í™”ë©´í‘œ â–¶ RAW ìˆœìœ¼ë¡œ "ì •í™•íˆ RAWì™€ ë§¤ì¹­ë˜ëŠ”" ë ˆì½”ë“œë¥¼ ì°¾ì•„ì˜¤ëŠ” í—¬í¼
  // í™”ë©´/ì„ íƒ ì—¬ë¶€ ë¬´ì‹œ: í•­ìƒ "ë°ì´í„° ìˆœì„œ" ê¸°ì¤€ìœ¼ë¡œ ë°˜í™˜
  function getRecordForIndex(i){
    if (Array.isArray(RAW) && RAW[i-1]) return RAW[i-1];
    return null;
  }


  // gradeQuickê³¼ ë™ì¼í•œ ê·œì¹™ìœ¼ë¡œ ì •ë‹µí‚¤ ìƒì„± (ì„ íƒ â–¶ í™”ë©´í‘œ â–¶ RAW)
  function getAnswersFor(n){
    const answers = [];
    // a) ì„ íƒ
    try{
      const sel = (typeof getSelectedRecords === 'function') ? getSelectedRecords() : [];
      for (let i=0; i<Math.min(n, sel.length); i++){
        answers[i] = String(sel[i]?.answer ?? '').trim();
      }
    }catch{}
    // b) í™”ë©´í‘œ
    const rows = Array.from(document.querySelectorAll('#tbl tbody tr'));
    for (let i=0; i<Math.min(n, rows.length); i++){
      if (!answers[i]){
        const tds = rows[i].querySelectorAll('td');
        const val = (tds[5]?.textContent || '').trim();
        if (val) answers[i] = val;
      }
    }
    // c) RAW
    if (Array.isArray(RAW)){
      for (let i=0; i<Math.min(n, RAW.length); i++){
        if (!answers[i]){
          const val = String(RAW[i]?.answer ?? '').trim();
          if (val) answers[i] = val;
        }
      }
    }
    for (let i=0;i<n;i++){ if (answers[i]==null) answers[i]=''; }
    return answers;
  }

  async function makeWrongOnlyPaper(){
    const N = 20;
    const key = getAnswersFor(N);

    // 1) ì˜¤ë‹µ ì¸ë±ìŠ¤ ìˆ˜ì§‘
    const wrongIdx = [];
    for (let i=1;i<=N;i++){
      const inp = document.querySelector(`.ans-input[data-q="${i}"]`);
      const val = (inp?.value ?? '').trim();
      const ans = String(key[i-1] ?? '').trim();
      if (!val || !ans) continue;
      if (val !== ans) wrongIdx.push(i);
    }

    if (wrongIdx.length === 0){
      alert('ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š');
      return;
    }

    // 2) ì˜¤ë‹µ ì¸ë±ìŠ¤ â†’ RAWì™€ ë™ì¼í•œ ë ˆì½”ë“œë¡œ ë³€í™˜ â†’ selectedIds êµ¬ì„±
    const prevSelected = new Set(selectedIds);
    try{
      const ids = new Set();
      for (const i of wrongIdx){
        const rec = getRecordForIndex(i);
        if (!rec) continue;
        const id = (typeof makeId === 'function') ? makeId(rec) : `${rec.year}::${rec.number}::${rec.unit}::${rec.question}`;
        ids.add(id);
      }
      // ì„ íƒ êµì²´
      selectedIds = ids;
      if (typeof updateMakeBtn === 'function') updateMakeBtn();

      // 3) ê¸°ì¡´ ì‹œí—˜ì§€ ìƒì„± ë¡œì§ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ë””ìì¸/ì´ë¯¸ì§€ ë§¤ì¹­ ìœ ì§€)
      //    - buildSheets() ë‚´ë¶€ì—ì„œ resolveImageURL(rec.question)ë¡œ
      //      'ë¬¸ì œ ì œëª©ê³¼ ë™ì¼í•œ íŒŒì¼ëª…' ì´ë¯¸ì§€ë¥¼ ìë™ íƒìƒ‰/ì‚½ì…í•©ë‹ˆë‹¤.
      await buildSheets();
      // 4) ëª¨ë‹¬ì„ ìˆ¨ê¸°ê³  ë°”ë¡œ ì¸ì‡„
      try{ document.getElementById("quickOverlay").style.display = "none"; }catch(e){}
      window.print();
    }catch(err){
      console.error(err);
      alert('ì˜¤ë‹µ ì‹œí—˜ì§€ ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }finally{
      // 5) ê¸°ì¡´ ì„ íƒ ë³µì› (í™”ë©´ ìƒíƒœ ë³´ì¡´)
      selectedIds = prevSelected;
      if (typeof updateMakeBtn === 'function') updateMakeBtn();
    }
  }

  btn.addEventListener('click', makeWrongOnlyPaper);
})();


    });

</script>

  <!-- Quick Grader Modal -->
  <div id="quickOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="quickTitle">
    <div class="modal">
      <div class="close-x" id="quickClose" aria-label="ë‹«ê¸°">Ã—</div>
      <h3 id="quickTitle">ë¹ ë¥¸ ì±„ì </h3>
      <div id="quickBody"></div>
      <div class="actions">
        <button class="btn-secondary" id="btnGrade">ì±„ì í•˜ê¸°</button>
        <button class="btn" id="btnQuickMakeWrong">ë¹ ë¥¸ ì‹œí—˜ì§€ ìƒì„±</button>
      </div>
    </div>
  </div>

</body>
</html>
