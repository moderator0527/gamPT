<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>원가관리회계 시험지 생성기</title>

  <!-- Screen UI font -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />

  <style>
    :root{
      --brand:#10a37f; --bg:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --radius:14px; --shadow:0 6px 18px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font-family:"Pretendard",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo",Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line)}
    .container{max-width:1200px;margin:0 auto;padding:14px 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;letter-spacing:.2px;
      padding:8px 12px;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);background:#fff}
    .orb{width:12px;height:12px;border-radius:999px;background:radial-gradient(circle at 30% 30%,#8ff3da,var(--brand));
      box-shadow:0 0 14px rgba(16,163,127,.65)}
    .spacer{flex:1}
    .select{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--line);border-radius:12px;
      padding:8px 10px;box-shadow:var(--shadow)}
    .select label{font-size:12px;color:var(--muted)}
    .select select{border:none;outline:none;font-size:14px}
    .btn{appearance:none;border:none;outline:none;background:var(--brand);color:#fff;
      font-weight:700;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px}
    main{max-width:1200px;margin:18px auto;padding:0 16px 60px}
    .bar{display:flex;align-items:center;justify-content:space-between;margin:12px 0;gap:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);
      border-radius:999px;background:#fff;font-size:12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
    .card .card-body{padding:12px 14px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{text-align:left;padding:12px;background:#f9fafb;border-bottom:1px solid var(--line);font-weight:700}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top}

    /* ===== Print Layout ===== */
    #print-root{display:none}
    @media print{
      header, main{display:none !important}
      #print-root{display:block}
      @page{size:A4;margin:10mm}
      .sheet{page-break-after:always}
    }

    /* Print-only font */
    @font-face {
      font-family: 'GungsuhLocalFallback';
      src: local('궁서'), local('Gungsuh');
      font-weight: 400;
      font-style: normal;
    }
    #print-root{
      font-family:'GungsuhLocalFallback','궁서','Gungsuh',serif;
      color:#000;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }

    #print-root .sheet{
      position:relative;
      width:210mm;min-height:297mm;margin:0 auto;display:flex;flex-direction:column;
      padding:8mm 8mm 10mm;
    }

    .exam-header{position:relative;padding-top:2mm;padding-bottom:8mm;}
    .exam-title{ text-align:center;font-size:28pt;line-height:1;font-weight:500;letter-spacing:0.5px }
    .exam-session{ position:absolute;top:7mm;right:0;border:0.5px solid #000;padding:0.5mm 5mm;font-size:14pt;line-height:1;font-weight:1000; }

    /* Horizontal rule under title */
    .tmark-h{ position:relative;height:0;margin-top:3mm;border-top:1px solid #000 }

    /* Content wrapper directly under header (where the vertical line & grid live) */
    .content{ position:relative; width:100%; flex:1; }

    /* Vertical line: starts below header area only */
    .page-vline{
      position:absolute;
      left:50%; transform:translateX(-50%);
      top:-32px; bottom:0;         /* -32px below the content's top (i.e., under the header) */
      border-left:1px solid #000;
      pointer-events:none;
      z-index:1;                  /* keep low; images won't be occluded */
    }

    /* 2×2 fixed grid of images */
    .grid-2x2{
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-template-rows:1fr 1fr;
      column-gap:5mm;            /* wider center gutter so vertical line has space */
      row-gap:15mm;
      width:100%;
      flex:1;
      margin-top:-2mm;
    }
    .qimg{
      display:flex;align-items:center;justify-content:center;
      padding:0;
    }
    /* Pull images a bit away from the center line */
    .grid-2x2 > .qimg:nth-child(odd){  /* left column cells: 1,3 */
      padding-right:3mm;
    }
    .grid-2x2 > .qimg:nth-child(even){ /* right column cells: 2,4 */
      padding-left:3mm;
    }
    .qimg img{max-width:100%;max-height:100%;display:block}
    .sheet-footer{height:0}

    /* ===== Answer sheet styles ===== */
    .answer-title{ text-align:center;font-size:20pt;font-weight:700;margin-top:2mm;margin-bottom:6mm }
    .answer-table{ width:100%; border-collapse:collapse; font-size:12pt }
    .answer-table th, .answer-table td{ border:1px solid #000; padding:3mm 2mm; text-align:center }
    .answer-meta{ display:flex; justify-content:flex-end; gap:12mm; margin-bottom:4mm }

  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="title"><span class="orb"></span>원가관리회계 시험지 생성기</div>
        <div class="spacer"></div>

        <button class="btn" id="btnAll">전체 보기</button>
        <div class="select">
          <label>단원별</label>
          <select id="selUnit"><option value="">단원 선택</option></select>
        </div>
        <div class="select">
          <label>연도별</label>
          <select id="selYear"><option value="">연도 선택</option></select>
        </div>
        <div class="select"><label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="chkAnswers"> 정답표 포함</label></div>
        <button class="btn" id="btnMake" disabled>시험지 생성 (선택 0)</button>
      </div>

      <div class="row" style="margin-top:6px;gap:8px">
        <span class="hint" id="status">데이터 로딩 준비…</span>
      </div>
    </div>
  </header>

  <main>
    <div class="bar">
      <div class="badge">총 <b id="count">0</b>문항</div>
      <div class="hint">열 구성: 연도 / 문제번호 / 단원 / 문제(파일명) / 정답</div>
    </div>

    <div class="card">
      <div class="card-body">
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:44px">선택</th>
                <th style="width:100px">연도</th>
                <th style="width:120px">문제번호</th>
                <th style="width:140px">단원</th>
                <th>문제</th>
                <th style="width:80px">정답</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Fallback embedded CSV -->
  <script id="data-csv" type="text/plain">
연도,문제번호,단원,문제,답
2025,1,2,25_41,3
2025,2,4,25_42,3
2025,3,14,25_43,4
2025,4,5,25_44,4
2025,5,8,25_45,4
2025,6,12,25_46,3
2025,7,9,25_47,1
2025,8,13,25_48,2
2025,9,15,25_49,3
2025,10,16,25_50,5
2024,1,1,24_41,5
2024,2,2,24_42,3
2024,3,3,24_43,2
2024,4,2,24_44,1
2024,5,13,24_45,2
2024,6,5,24_46,1
2024,7,7,24_47,4
2024,8,8,24_48,5
2024,9,9,24_49,4
2024,10,15,24_50,3
  </script>

  <!-- Optional legacy hooks -->
  <script id="legacy-json" type="application/json" data-format="json"></script>
  <table id="rawData" style="display:none"></table>

  <div id="print-root"></div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const tbody = $('#tbl tbody');
    const countEl = $('#count');
    const selUnit = $('#selUnit');
    const selYear = $('#selYear');
    const statusEl = $('#status');
    const btnMake = $('#btnMake');
    const printRoot = $('#print-root');

    let RAW = [];
    let MODE = 'all';
    let selectedIds = new Set();
    let dataSourceNote = '';

    // helpers
    const escapeHtml = (s)=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    function uniqueSorted(arr){
      return [...new Set(arr.filter(Boolean))].sort((a,b)=>{
        const na=Number(a), nb=Number(b);
        if(!Number.isNaN(na) && !Number.isNaN(nb)) return nb-na;
        return String(a).localeCompare(String(b),'ko');
      });
    }
    function normalizeHeader(h){
      const t = String(h).trim().toLowerCase();
      const map = {
        '연도':'year','년도':'year','year':'year',
        '문제번호':'number','번호':'number','no':'number','문항번호':'number','qno':'number','number':'number',
        '단원':'unit','unit':'unit',
        '문제':'question','문항':'question','question':'question','파일':'question','파일명':'question','이름':'question',
        '답':'answer','정답':'answer','answer':'answer'
      };
      return map[t] || t;
    }
    function parseCSV(text){
      if(!text) return [];
      const sep = text.indexOf('\t')>=0 && text.indexOf(',')===-1 ? '\t' : ',';
      const rows = [];
      let i=0, cur='', inQ=false, row=[];
      const pushCell=()=>{ row.push(cur); cur=''; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      while(i<text.length){
        const ch = text[i];
        if(inQ){
          if(ch==='\"'){ if(text[i+1]==='\"'){ cur+='\"'; i++; } else inQ=false; }
          else cur+=ch;
        } else {
          if(ch==='\"') inQ=true;
          else if(ch===sep) pushCell();
          else if(ch==='\n'){ pushCell(); pushRow(); }
          else if(ch==='\r'){} else cur+=ch;
        }
        i++;
      }
      if(cur!=='' || row.length){ pushCell(); pushRow(); }
      if(rows.length===0) return [];
      const header = rows[0].map(normalizeHeader);
      const idx = {
        year: header.indexOf('year'),
        number: header.indexOf('number'),
        unit: header.indexOf('unit'),
        question: header.indexOf('question'),
        answer: header.indexOf('answer')
      };
      const out=[];
      for(let r=1;r<rows.length;r++){
        const rec = rows[r];
        if(!rec || rec.every(v=>String(v||'').trim()==='')) continue;
        out.push({
          year: idx.year>=0 ? (rec[idx.year]||'').trim() : '',
          number: idx.number>=0 ? (rec[idx.number]||'').trim() : '',
          unit: idx.unit>=0 ? (rec[idx.unit]||'').trim() : '',
          question: idx.question>=0 ? (rec[idx.question]||'').trim() : '',
          answer: idx.answer>=0 ? (rec[idx.answer]||'').trim() : ''
        });
      }
      return out;
    }
    function parseJSON(text){
      try{
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) return [];
        return arr.map(obj=>({
          year: (obj.year ?? obj.연도 ?? obj.년도 ?? '').toString(),
          number: (obj.number ?? obj.no ?? obj.문제번호 ?? obj.번호 ?? '').toString(),
          unit: (obj.unit ?? obj.단원 ?? '').toString(),
          question: (obj.question ?? obj.문제 ?? obj.파일명 ?? obj.file ?? '').toString(),
          answer: (obj.answer ?? obj.정답 ?? obj.답 ?? '').toString()
        }));
      }catch(e){ return []; }
    }
    function parseHTMLTable(table){
      if(!table) return [];
      const ths = Array.from(table.querySelectorAll('thead th, tr:first-child th, tr:first-child td')).map(el=>normalizeHeader(el.textContent));
      const idx = {
        year: ths.indexOf('year'),
        number: ths.indexOf('number'),
        unit: ths.indexOf('unit'),
        question: ths.indexOf('question'),
        answer: ths.indexOf('answer')
      };
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const startRows = rows.length ? rows : Array.from(table.querySelectorAll('tr')).slice(1);
      return startRows.map(tr=>{
        const tds = Array.from(tr.children);
        const pick = (i)=> (i>=0 && tds[i]) ? tds[i].textContent.trim() : '';
        return {
          year: pick(idx.year), number: pick(idx.number), unit: pick(idx.unit),
          question: pick(idx.question), answer: pick(idx.answer)
        };
      }).filter(r=>Object.values(r).some(v=>v));
    }
    function rebuildFilters(data){
      const units = uniqueSorted(data.map(d=>d.unit));
      selUnit.innerHTML = '<option value=\"\">단원 선택</option>' + units.map(u=>`<option value=\"${escapeHtml(u)}\">${escapeHtml(u)}</option>`).join('');
      const years = uniqueSorted(data.map(d=>d.year));
      selYear.innerHTML = '<option value=\"\">연도 선택</option>' + years.map(y=>`<option value=\"${escapeHtml(y)}\">${escapeHtml(y)}</option>`).join('');
    }
    function applyFilter(mode,value,data){
      if(mode==='unit' && value) return data.filter(d=>String(d.unit)===String(value));
      if(mode==='year' && value) return data.filter(d=>String(d.year)===String(value));
      return data;
    }
    const makeId = (rec)=>`${rec.year}::${rec.number}::${rec.unit}::${rec.question}`;

    function render(items){
      tbody.innerHTML = items.map(it=>{
        const id = makeId(it);
        const checked = selectedIds.has(id) ? 'checked' : '';
        return `
        <tr>
          <td><input type="checkbox" class="rowchk" data-id="${escapeHtml(id)}" ${checked}></td>
          <td>${escapeHtml(it.year??'')}</td>
          <td>${escapeHtml(it.number??'')}</td>
          <td>${escapeHtml(it.unit??'')}</td>
          <td>${escapeHtml(it.question??'')}</td>
          <td>${escapeHtml(it.answer??'')}</td>
        </tr>`;
      }).join('');
      tbody.querySelectorAll('.rowchk').forEach((el)=>{
        el.addEventListener('change', (e)=>{
          const rid = e.currentTarget.dataset.id;
          if(e.currentTarget.checked) selectedIds.add(rid);
          else selectedIds.delete(rid);
          updateMakeBtn();
        });
      });
      countEl.textContent = String(items.length);
      updateMakeBtn();
    }
    function updateMakeBtn(){
      const n = selectedIds.size;
      btnMake.textContent = `시험지 생성 (선택 ${n})`;
      btnMake.disabled = n===0;
    }
    function setMode(m){ MODE=m; updateView(); }
    function updateView(){
      let items = RAW;
      if(MODE==='unit' && selUnit.value) items = applyFilter('unit', selUnit.value, RAW);
      else if(MODE==='year' && selYear.value) items = applyFilter('year', selYear.value, RAW);
      render(items);
    }

    function mergeUnique(base, extra){
      const set = new Set(base.map(makeId));
      const out = base.slice();
      for(const r of extra||[]){
        const rec = {
          year: (r.year??'').toString().trim(),
          number: (r.number??'').toString().trim(),
          unit: (r.unit??'').toString().trim(),
          question: (r.question??'').toString().trim(),
          answer: (r.answer??'').toString().trim(),
        };
        const id = makeId(rec);
        if(rec.question && !set.has(id)){ out.push(rec); set.add(id); }
      }
      return out;
    }

    function detectAndLoadAllSources(){
      let data = [];
      dataSourceNote = '';

      // JSON blocks
      const jsonBlocks = Array.from(document.querySelectorAll('script[type="application/json"][data-format="json"], script[type="application/json"][data-role="problems"]'));
      for(const s of jsonBlocks){
        const arr = parseJSON(s.textContent);
        if(arr.length){
          data = mergeUnique(data, arr);
          dataSourceNote += `JSON ${arr.length}건, `;
        }
      }

      // CSV blocks
      const csvBlocks = Array.from(document.querySelectorAll('script[type="text/plain"][data-format="csv"], script#data-csv[type="text/plain"]'));
      for(const s of csvBlocks){
        const arr = parseCSV((s.textContent||'').trim());
        if(arr.length){
          data = mergeUnique(data, arr);
          dataSourceNote += `CSV ${arr.length}건, `;
        }
      }

      // HTML table
      const table = document.querySelector('#rawData,[data-role="raw-data"]');
      if(table){
        const arr = parseHTMLTable(table);
        if(arr.length){
          data = mergeUnique(data, arr);
          dataSourceNote += `TABLE ${arr.length}건, `;
        }
      }

      if(!data.length){
        dataSourceNote = '내장 예시 데이터 사용';
      }else{
        dataSourceNote = dataSourceNote.replace(/, $/, '');
      }

      return data;
    }

    // ==== 이미지 자동 매칭 ====
    const CANDIDATE_DIRS = ['./', './problems/'];
    const CANDIDATE_EXTS = ['png','jpg','jpeg','webp','PNG','JPG','JPEG','WEBP'];
    function resolveImageURL(baseName){
      return new Promise((resolve)=>{
        let idx = 0;
        const tries = [];
        for(const dir of CANDIDATE_DIRS){
          for(const ext of CANDIDATE_EXTS){
            tries.push(dir + baseName + '.' + ext);
          }
        }
        const tryNext = ()=>{
          if(idx>=tries.length){ resolve(null); return; }
          const url = tries[idx++];
          const img = new Image();
          img.onload = ()=>resolve(url);
          img.onerror = tryNext;
          img.src = url;
        };
        tryNext();
      });
    }

    function getSelectedRecords(){
      const idset = new Set(selectedIds);
      return RAW.filter(rec=>idset.has(makeId(rec)));
    }
    function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }

    async function buildSheets(){
      const includeAnswers = (document.getElementById('chkAnswers')?.checked) === true;

      const records = getSelectedRecords();
      printRoot.innerHTML = '';

      const groups = chunk(records, 4);
      const imgPromises = [];

      for(const group of groups){
        const sheet = document.createElement('div');
        sheet.className = 'sheet';

        // header
        const header = document.createElement('div');
        header.className = 'exam-header';
        header.innerHTML = `
          <div class="exam-title">원가관리회계</div>
          <div class="exam-session">1교시</div>
          <div class="tmark-h"></div>
        `;
        sheet.appendChild(header);

        // content (holds vertical line + grid)
        const content = document.createElement('div');
        content.className = 'content';

        // vertical line
        const vline = document.createElement('div');
        vline.className = 'page-vline';
        content.appendChild(vline);

        // 2x2 grid
        const grid = document.createElement('div');
        grid.className = 'grid-2x2';

        for(const rec of group){
          const cell = document.createElement('div');
          cell.className = 'qimg';
          const key = String(rec.question||'').trim();
          const p = resolveImageURL(key).then(url=>{
            if(url){
              const im = new Image();
              im.src = url;
              cell.appendChild(im);
              return new Promise(r=>{ im.onload = r; im.onerror = r; });
            }else{
              const miss = document.createElement('div');
              miss.className = 'hint';
              miss.textContent = `이미지 없음: ${key}`;
              cell.appendChild(miss);
            }
          });
          imgPromises.push(p);
          grid.appendChild(cell);
        }
        // pad to 4
        for(let i=group.length;i<4;i++){
          const pad = document.createElement('div');
          pad.className = 'qimg';
          grid.appendChild(pad);
        }

        content.appendChild(grid);
        sheet.appendChild(content);
        sheet.appendChild(Object.assign(document.createElement('div'), {className:'sheet-footer'}));
        printRoot.appendChild(sheet);
      }

      await Promise.all(imgPromises);

      if(includeAnswers){
        const ans = document.createElement('div');
        ans.className = 'sheet';

        const header = document.createElement('div');
        header.className = 'exam-header';
        header.innerHTML = `<div class="answer-title">정답표</div>`;
        ans.appendChild(header);

        const table = document.createElement('table');
        table.className = 'answer-table';
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width:18mm">No.</th>
              <th style="width:24mm">연도</th>
              <th style="width:26mm">문제번호</th>
              <th>문제(파일명)</th>
              <th style="width:22mm">정답</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        const records = getSelectedRecords();
        records.forEach((rec, idx)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${rec.year??''}</td>
            <td>${rec.number??''}</td>
            <td>${rec.question??''}</td>
            <td>${rec.answer??''}</td>
          `;
          tbody.appendChild(tr);
        });
        ans.appendChild(table);
        printRoot.appendChild(ans);
      }
    }

    // Init
    (function boot(){
      let data = detectAndLoadAllSources();
      if(!data.length){
        const csvNode = document.getElementById('data-csv');
        const text = (csvNode && csvNode.textContent || '').trim();
        data = parseCSV(text);
      }
      RAW = data;
      if(RAW.length){
        rebuildFilters(RAW); setMode('all'); render(RAW);
        statusEl.textContent = `20251021 데이터 버전. 총 20문항.`;
      } else {
        statusEl.textContent = '데이터가 비어있습니다.';
      }
    })();

    // Events
    $('#btnAll').addEventListener('click', ()=>{ selUnit.value=''; selYear.value=''; setMode('all'); render(RAW); });
    selUnit.addEventListener('change',()=>{ setMode('unit'); });
    selYear.addEventListener('change',()=>{ setMode('year'); });

    btnMake.addEventListener('click', async ()=>{
      try{
        btnMake.disabled = true;
        btnMake.textContent = '생성 중...';
        await buildSheets();
        btnMake.textContent = '인쇄 창 여는 중...';
        window.print();
      }catch(err){
        console.error(err);
        alert('시험지 생성 중 오류가 발생했습니다. 이미지 경로/파일명을 확인해주세요.');
      }finally{
        btnMake.disabled = selectedIds.size===0;
        btnMake.textContent = `시험지 생성 (선택 ${selectedIds.size})`;
      }
    });
  </script>
</body>
</html>
